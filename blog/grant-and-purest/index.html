<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/mysite/commons.2f2933dc343b474e635f.css">code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::-moz-selection,code[class*=language-] ::-moz-selection,pre[class*=language-]::-moz-selection,pre[class*=language-] ::-moz-selection{text-shadow:none;background:#b3d4fc}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.15.36"/><title data-react-helmet="true">Andrey Azov: Personal Website</title><link data-react-helmet="true" href="https://fonts.googleapis.com/css?family=PT+Sans" rel="stylesheet"/><link data-react-helmet="true" href="https://fonts.googleapis.com/css?family=PT+Serif" rel="stylesheet"/><meta data-react-helmet="true" charSet="utf-8"/><style data-styled="sWndC kEiOhI iOdCCZ jFRIjY jgXULE deNPVQ JnEwf eAChFE gJtlwY eFGsQn" data-styled-version="4.4.0">
/* sc-component-id: menu-button__HamburgerButton-uovo3g-0 */
.sWndC{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;position:absolute;top:20px;left:90px;width:40px;height:40px;border:1px solid black;border-radius:50%;box-shadow:1px 2px 1px #888888;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;} .sWndC:hover{-webkit-animation:efFnpw 1s ease-in-out;animation:efFnpw 1s ease-in-out;} @media screen and (max-width:1000px){.sWndC{left:2rem;}}
/* sc-component-id: menu-button__Hamburger-uovo3g-1 */
.kEiOhI{height:20px;width:28px;}
/* sc-component-id: side-menu__SideMenuContainer-sc-1t4nr90-0 */
.iOdCCZ{position:fixed;top:0;left:0;width:300px;height:100vh;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;background:#262626;-webkit-transform:translateX(-100%);-ms-transform:translateX(-100%);transform:translateX(-100%);z-index:5;} @media screen and (max-width:767px){.iOdCCZ{width:100%;}}
/* sc-component-id: blog-post__DateElement-sc-9t6qfp-0 */
.eFGsQn{font-style:italic;font-size:2.3rem;}
/* sc-component-id: page-container-sc-1mgw8t6-0 */
.eAChFE{max-width:960px;margin:20px auto;padding:0 2rem 4rem;font-size:2rem;} @media screen and (max-width:1000px){.eAChFE{margin-top:90px;}} .eAChFE img{max-width:100%;}
/* sc-component-id: sc-global-1629448868 */
html,body{padding:0;margin:0;font-size:10px;} body{font-family:'PT Serif',serif;} h1{font-family:'PT Sans',serif;font-size:3.5rem;} h2{font-family:'PT Sans',serif;font-size:2.6rem;} h3{font-family:'PT Sans',serif;font-size:2rem;} a{color:blue;-webkit-text-decoration:none;text-decoration:none;} a:visited{color:blue;} a:hover{-webkit-text-decoration:underline;text-decoration:underline;} p{font-size:2rem;line-height:1.4;} blockquote{margin:0;padding-left:1.2em;padding-top:0.3em;padding-bottom:0.3em;border-left:5px solid grey;color:#666666;} blockquote p{margin:0;}
/* sc-component-id: side-menu__CloseButton-sc-1t4nr90-5 */
.jFRIjY{position:absolute;right:20px;top:20px;cursor:pointer;}
/* sc-component-id: side-menu__CloseIcon-sc-1t4nr90-6 */
.jgXULE{width:20px;height:20px;fill:white;}
/* sc-component-id: side-menu__MenuItemsContainer-sc-1t4nr90-3 */
.deNPVQ{position:absolute;top:50vh;left:50%;list-style:none;padding:0;-webkit-transform:translateX(-90%) translateY(-90%);-ms-transform:translateX(-90%) translateY(-90%);transform:translateX(-90%) translateY(-90%);}
/* sc-component-id: side-menu__MenuItem-sc-1t4nr90-4 */
.JnEwf{color:white;font-size:30px;margin-bottom:1.6rem;} .JnEwf a{color:white;}</style><style data-styled="efFnpw" data-styled-version="4.4.0">
/* sc-component-id: sc-keyframes-efFnpw */
@-webkit-keyframes efFnpw{16.65%{-webkit-transform:translateY(8px);-webkit-transform:translateY(3px);-ms-transform:translateY(3px);transform:translateY(3px);}33.3%{-webkit-transform:translateY(-6px);-webkit-transform:translateY(-2px);-ms-transform:translateY(-2px);transform:translateY(-2px);}49.95%{-webkit-transform:translateY(4px);-webkit-transform:translateY(2px);-ms-transform:translateY(2px);transform:translateY(2px);}66.6%{-webkit-transform:translateY(-2px);-webkit-transform:translateY(-1px);-ms-transform:translateY(-1px);transform:translateY(-1px);}83.25%{-webkit-transform:translateY(1px);-webkit-transform:translateY(1px);-ms-transform:translateY(1px);transform:translateY(1px);}100%{-webkit-transform:translateY(0);-webkit-transform:translateY(0);-ms-transform:translateY(0);transform:translateY(0);}} @keyframes efFnpw{16.65%{-webkit-transform:translateY(8px);-webkit-transform:translateY(3px);-ms-transform:translateY(3px);transform:translateY(3px);}33.3%{-webkit-transform:translateY(-6px);-webkit-transform:translateY(-2px);-ms-transform:translateY(-2px);transform:translateY(-2px);}49.95%{-webkit-transform:translateY(4px);-webkit-transform:translateY(2px);-ms-transform:translateY(2px);transform:translateY(2px);}66.6%{-webkit-transform:translateY(-2px);-webkit-transform:translateY(-1px);-ms-transform:translateY(-1px);transform:translateY(-1px);}83.25%{-webkit-transform:translateY(1px);-webkit-transform:translateY(1px);-ms-transform:translateY(1px);transform:translateY(1px);}100%{-webkit-transform:translateY(0);-webkit-transform:translateY(0);-ms-transform:translateY(0);transform:translateY(0);}}</style><style type="text/css">.gatsby-resp-image-image{width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;color:transparent;}</style><link as="script" rel="preload" href="/mysite/app-563df887bf089d60b2fa.js"/><link as="script" rel="preload" href="/mysite/component---src-templates-blog-post-js-94353da1bad9038d4cfb.js"/><link as="script" rel="preload" href="/mysite/commons-6c46fe7066586a1e6959.js"/><link as="script" rel="preload" href="/mysite/webpack-runtime-8e274e0237ac9232ad64.js"/><link as="fetch" rel="preload" href="/mysite/page-data/blog/grant-and-purest/page-data.json" crossorigin="anonymous"/></head><body><noscript id="gatsby-noscript">This app works best with JavaScript enabled.</noscript><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div><div class="menu-button__HamburgerButton-uovo3g-0 sWndC"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 20" version="1.1" class="menu-button__Hamburger-uovo3g-1 kEiOhI"><g><rect ry="2" height="4" width="28" y="0" x="0"></rect><rect ry="2" height="4" width="28" y="8" x="0"></rect><rect ry="2" height="4" width="28" y="16" x="0"></rect></g></svg></div><div class="side-menu__SideMenuContainer-sc-1t4nr90-0 iOdCCZ"><div class="side-menu__CloseButton-sc-1t4nr90-5 jFRIjY"><svg viewBox="0 0 24 24" class="side-menu__CloseIcon-sc-1t4nr90-6 jgXULE"><path d="M13.4 12l9.3-9.3c.4-.4.4-1 0-1.4s-1-.4-1.4 0L12 10.6 2.7 1.3c-.4-.4-1-.4-1.4 0s-.4 1 0 1.4l9.3 9.3-9.3 9.3c-.4.4-.4 1 0 1.4.2.2.4.3.7.3s.5-.1.7-.3l9.3-9.3 9.3 9.3c.2.2.5.3.7.3s.5-.1.7-.3c.4-.4.4-1 0-1.4L13.4 12z"></path></svg></div><ul class="side-menu__MenuItemsContainer-sc-1t4nr90-3 deNPVQ"><li class="side-menu__MenuItem-sc-1t4nr90-4 JnEwf"><a href="/mysite/about/">about</a></li><li class="side-menu__MenuItem-sc-1t4nr90-4 JnEwf"><a href="/mysite/blog/">blog</a></li><li class="side-menu__MenuItem-sc-1t4nr90-4 JnEwf"><a href="/mysite/diary/">diary</a></li></ul></div><main class="page-container-sc-1mgw8t6-0 eAChFE"><h1 class="page-title__Title-sc-1kqm3zm-0 gJtlwY">Authenticating with social networks and getting user data from them</h1><p class="blog-post__DateElement-sc-9t6qfp-0 eFGsQn">08 January, 2019</p><div><h2>Using Purest</h2>
<p>The <code class="language-text">prepareSocialAuthPayload</code> function from the code snippet below
will be called by the callback middleware that receives the request from the
social network. The request will contain either the <code class="language-text">access_token</code> query parameter
(if the social network is using oauth2 protocol) or the <code class="language-text">access_token</code> and <code class="language-text">access_secret</code>
parameters (if the social network is using oauth1 protocol).</p>
<div class="gatsby-highlight" data-language="javascript"><pre class="language-javascript"><code class="language-javascript"><span class="token keyword">import</span> request <span class="token keyword">from</span> <span class="token string">'request'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> Purest <span class="token keyword">from</span> <span class="token string">'purest'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> purestConfig <span class="token keyword">from</span> <span class="token string">'@purest/providers'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> purest <span class="token operator">=</span> <span class="token function">Purest</span><span class="token punctuation">(</span><span class="token punctuation">{</span> request<span class="token punctuation">,</span> promise<span class="token punctuation">:</span> Promise <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> facebook <span class="token operator">=</span> <span class="token function">purest</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  provider<span class="token punctuation">:</span> <span class="token string">'facebook'</span><span class="token punctuation">,</span>
  config<span class="token punctuation">:</span> purestConfig
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> twitter <span class="token operator">=</span> <span class="token function">purest</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  provider<span class="token punctuation">:</span> <span class="token string">'twitter'</span><span class="token punctuation">,</span>
  config<span class="token punctuation">:</span> purestConfig<span class="token punctuation">,</span>
  key<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// Twitter key for your app,</span>
  secret<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// Twitter secret for your app,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> vk <span class="token operator">=</span> <span class="token function">purest</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  provider<span class="token punctuation">:</span> <span class="token string">'vk'</span><span class="token punctuation">,</span>
  config<span class="token punctuation">:</span> purestConfig
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> google <span class="token operator">=</span> <span class="token function">purest</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  provider<span class="token punctuation">:</span> <span class="token string">'google'</span><span class="token punctuation">,</span>
  config<span class="token punctuation">:</span> purestConfig
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// exported function that will be called elsewhere and receive Express request object</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">prepareSocialAuthPayload</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> provider</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>provider <span class="token operator">===</span> <span class="token string">'facebook'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">prepareFacebookPayload</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>provider <span class="token operator">===</span> <span class="token string">'twitter'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">prepareTwitterPayload</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>provider <span class="token operator">===</span> <span class="token string">'vkontakte'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">prepareVkPayload</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>provider <span class="token operator">===</span> <span class="token string">'google'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">prepareGooglePayload</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Failed to collect social network data:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">prepareFacebookPayload</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> access_token <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> responseBody<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> facebook
    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'me'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">qs</span><span class="token punctuation">(</span><span class="token punctuation">{</span> fields<span class="token punctuation">:</span> <span class="token string">'name,email,picture.width(50).height(50)'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span>access_token<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> responseBody<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    picture<span class="token punctuation">:</span> responseBody<span class="token punctuation">.</span>picture<span class="token punctuation">.</span>data<span class="token punctuation">.</span>url<span class="token punctuation">,</span>
    email<span class="token punctuation">:</span> responseBody<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
    providerTokenData<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      access_token
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    provider<span class="token punctuation">:</span> <span class="token string">'Facebook'</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">prepareTwitterPayload</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> access_token<span class="token punctuation">,</span> access_secret <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> responseBody<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> twitter
    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'account/verify_credentials'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">qs</span><span class="token punctuation">(</span><span class="token punctuation">{</span> include_email<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span>access_token<span class="token punctuation">,</span> access_secret<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> responseBody<span class="token punctuation">.</span>name <span class="token operator">||</span> responseBody<span class="token punctuation">.</span>screen_name<span class="token punctuation">,</span>
    picture<span class="token punctuation">:</span> responseBody<span class="token punctuation">.</span>profile_image_url_https <span class="token operator">||</span> responseBody<span class="token punctuation">.</span>profile_image_url<span class="token punctuation">,</span>
    email<span class="token punctuation">:</span> responseBody<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
    providerTokenData<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token comment">// Twitter uses oauth1 protocol</span>
      oauth_token<span class="token punctuation">:</span> access_token<span class="token punctuation">,</span>
      oauth_secret<span class="token punctuation">:</span> access_secret
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    provider<span class="token punctuation">:</span> <span class="token string">'Twitter'</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">prepareVkPayload</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> access_token<span class="token punctuation">,</span> raw <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
  logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'raw from Vkontakte'</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> responseBody<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> vk
    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'users.get'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">qs</span><span class="token punctuation">(</span><span class="token punctuation">{</span> v<span class="token punctuation">:</span> <span class="token string">'5.85'</span><span class="token punctuation">,</span> fields<span class="token punctuation">:</span> <span class="token string">'photo_50'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// "v" for api version is a required parameter</span>
    <span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span>access_token<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* VK response will have the following shape:
    { "response": [
      { "id",
        "first_name",
        "last_name",
        "photo_50""
      }
    ]}
  */</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> first_name<span class="token punctuation">,</span> last_name<span class="token punctuation">,</span> photo_50 <span class="token punctuation">}</span> <span class="token operator">=</span> responseBody<span class="token punctuation">.</span>response<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>first_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>last_name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    picture<span class="token punctuation">:</span> photo_50<span class="token punctuation">,</span>
    email<span class="token punctuation">:</span> raw<span class="token punctuation">.</span>email<span class="token punctuation">,</span> <span class="token comment">// VK returns user's email in the same response as access_token</span>
    providerTokenData<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      access_token
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    provider<span class="token punctuation">:</span> <span class="token string">'VK'</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">prepareGooglePayload</span><span class="token punctuation">(</span><span class="token parameter">req</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> access_token <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> responseBody<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> google
    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'oauth2/v1/userinfo'</span><span class="token punctuation">)</span> <span class="token comment">// https://www.googleapis.com/oauth2/v1/userinfo</span>
    <span class="token punctuation">.</span><span class="token function">auth</span><span class="token punctuation">(</span>access_token<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> responseBody<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
    email<span class="token punctuation">:</span> responseBody<span class="token punctuation">.</span>email<span class="token punctuation">,</span>
    picture<span class="token punctuation">:</span> responseBody<span class="token punctuation">.</span>picture<span class="token punctuation">,</span>
    providerTokenData<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      access_token
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    provider<span class="token punctuation">:</span> <span class="token string">'Google'</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre></div></div></main></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/grant-and-purest/";window.webpackCompilationHash="4d3c1df2c63372136643";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-563df887bf089d60b2fa.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-94353da1bad9038d4cfb.js"],"component---src-pages-about-index-js":["/component---src-pages-about-index-js-109a700b4af2ff7e9adf.js"],"component---src-pages-blog-index-js":["/component---src-pages-blog-index-js-e5ce97bee8a684c76bb7.js"],"component---src-pages-diary-index-js":["/component---src-pages-diary-index-js-e9b6e0cd6c10da679426.js"],"component---src-pages-index-js":["/component---src-pages-index-js-f6fd3ca9187e689d2450.js"],"component---src-pages-publications-index-js":["/component---src-pages-publications-index-js-b53df26a4a49827b198e.js"]};/*]]>*/</script><script src="/mysite/webpack-runtime-8e274e0237ac9232ad64.js" async=""></script><script src="/mysite/commons-6c46fe7066586a1e6959.js" async=""></script><script src="/mysite/component---src-templates-blog-post-js-94353da1bad9038d4cfb.js" async=""></script><script src="/mysite/app-563df887bf089d60b2fa.js" async=""></script></body></html>